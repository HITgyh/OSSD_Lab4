name: tests
on: push
jobs:
  run_tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Cache Maven packages
        uses: actions/cache@v2
        with:
            path: ~/.m2/repository
            key: ${{runner.os}}-maven-${{hashFiles('**/pom.xml')}}
            restore-keys: ${{runner.os}}-maven
      - name: Run test with Maven
        run: mvn -B test --file pom.xml
merge:
  needs: build
  runs-on: ubuntu-latest
  if: github.event_name == 'pull_request' && github.event.action == 'synchronize'
  steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Merge PR
      run: |
        git fetch origin
        git checkout ${GITHUB_HEAD_REF}
        git merge origin/${GITHUB_BASE_REF} --no-commit --no-ff
        git push origin HEAD:${GITHUB_HEAD_REF}
    - name: Auto-Merge
      uses: pascalgn/automerge-action@v0.13.1
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        merge_method: squash
        merge_commit_message: "auto-merge: {{commit-message}}"
        merge_filter: "label=automerge"
